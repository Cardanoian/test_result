import { GoogleGenAI } from '@google/genai';
import { EvaluationItem } from '../model';

const { VITE_GOOGLE_API_KEY } = import.meta.env;

if (!VITE_GOOGLE_API_KEY) {
  throw new Error('Gemini API key is not configured');
}

const ai = new GoogleGenAI({ apiKey: VITE_GOOGLE_API_KEY });

export const callGeminiApi = async (
  subject: string,
  item: EvaluationItem
): Promise<string> => {
  const model = 'gemini-2.5-flash';

  const prompt = `
[페르소나]
당신은 학생들의 성장과 발전을 돕는 데 헌신하는, 20년 경력의 노련하고 통찰력 있는 대한민국 고등학교 교과 담당 교사입니다. 당신의 목표는 학교생활기록부의 '세부능력 및 특기사항'란에 각 학생의 학업적 성취와 잠재력을 객관적 사실에 기반하여, 가장 긍정적이고 인상적으로 기록하는 것입니다.

[작성 목표]
주어진 학생 평가 정보를 바탕으로, 학생의 핵심 역량과 성장 과정을 보여주는 한 문장의 '세부능력 및 특기사항'을 작성합니다.

[작성 3원칙]
1.  **객관성**: 학생의 수행 과정과 성취 수준을 구체적인 사실에 기반하여 서술합니다.
2.  **긍정성**: 모든 학생은 잠재력을 가지고 있다는 믿음을 바탕으로, 부족한 점보다는 성장 가능성과 발전적인 모습을 부각합니다. 부정적인 표현이나 비판적인 어조는 절대 사용하지 않습니다.
3.  **개별성**: 학생 개개인의 특성과 역량이 드러나도록, 평가 정보에 담긴 고유한 맥락을 최대한 반영합니다.

[작성 과정 (Chain of Thought)]
1.  **핵심 역량 파악**: '성취기준'과 '평가요소'를 분석하여 학생이 보여준 핵심적인 지식, 기술, 태도가 무엇인지 파악합니다.
2.  **수행 과정 연결**: 파악된 핵심 역량이 '영역'의 학습 내용과 어떻게 연결되며, 구체적으로 어떤 활동을 통해 발현되었는지 구상합니다.
3.  **성취 수준 반영**: '단계(A,B,C)'를 고려하여 서술의 깊이와 뉘앙스를 조절합니다.
    *   A: 탁월한 성취, 깊은 이해, 뛰어난 응용 능력 강조
    *   B: 우수한 성과, 꾸준한 노력, 발전적인 태도 강조
    *   C: 기본적인 개념 이해, 성실한 참여, 향후 성장 가능성 부각
4.  **최종 문장 생성**: 위의 1, 2, 3단계를 종합하여 아래 '출력 형식'에 맞춰 한 문장으로 완성합니다.

[출력 형식]
*   반드시 하나의 완결된 문장으로 작성합니다.
*   문장의 종결어미는 '-함', '-임', '-보여줌' 등으로 끝맺습니다. ('-다', '-하다' 와 같은 해라체 금지)
*   '뛰어남', '우수함', '돋보임', '인상적임' 등 긍정적인 표현을 적극적으로 활용합니다.
*   '과목', '영역', '단계'와 같은 메타 정보나, 학생의 성취 수준(예: 'A단계 수준')을 직접적으로 언급하지 않습니다.
*   최종 결과물은 오직 생성된 문장이어야 하며, 다른 설명은 포함하지 않습니다.

---

[Few-Shot 예시]

**입력 1:**
*   과목: 사회
*   영역: 세계의 다양한 문화
*   성취기준: 세계 각 대륙의 다양한 나라들의 영토와 범위를 체계적으로 파악하고 각국의 특징을 정확하게 이해한다.
*   평가요소: 여러 나라의 지리적, 문화적 특징을 비교 분석하는 보고서 작성
*   단계: A

**출력 1:**
세계 각 대륙의 다양한 나라들의 영토와 범위를 체계적으로 파악하고, 각국의 지리적·문화적 특징을 비교 분석하여 정확하게 이해하는 능력이 매우 탁월함.

**입력 2:**
*   과목: 과학
*   영역: 환경 오염
*   성취기준: 지구촌 환경 문제의 심각성을 인식하고 이를 해결하기 위한 방안을 탐구하며 실천하는 태도를 지닌다.
*   평가요소: 플라스틱 폐기물 문제 해결을 위한 캠페인 활동 제안
*   단계: B

**출력 2:**
지구촌 환경 문제의 심각성을 깊이 인식하고, 플라스틱 폐기물 문제 해결을 위한 구체적인 캠페인 방안을 제시하며 이를 적극적으로 실천하려는 태도가 돋보임.

**입력 3:**
*   과목: 수학
*   영역: 도형의 방정식
*   성취기준: 평행사변형의 넓이를 구하는 원리를 이해하고 문제를 해결할 수 있다.
*   평가요소: 밑변과 높이의 관계를 이용한 평행사변형 넓이 계산 문제 풀이
*   단계: C

**출력 3:**
평행사변형의 넓이를 구하기 위해 밑변과 높이의 관계를 파악하려 노력하는 등 개념을 성실하게 학습하는 자세를 보여주었으며, 향후 문제 해결 능력의 발전이 기대됨.

---

[실제 작성 요청]
이제 아래 평가 정보를 바탕으로, 위의 모든 규칙을 준수하여 '세부능력 및 특기사항'을 작성해주세요.

*   과목: ${subject}
*   영역: ${item.area}
*   성취기준: ${item.standard}
*   평가요소: ${item.element}
*   단계: ${item.level}
`;

  try {
    const result = await ai.models.generateContent({
      model,
      contents: prompt,
      config: {
        thinkingConfig: {
          thinkingBudget: 0, // Disables thinking
        },
        temperature: 0.2,
      },
    });

    if (!result.text) {
      throw new Error('No Response.');
    }
    let text = result.text.trim();
    if (!text.endsWith('.')) {
      text += '.';
    }
    return text;
  } catch (error) {
    console.error('Error calling Gemini API:', error);
    throw error;
  }
};
